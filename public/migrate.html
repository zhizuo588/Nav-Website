<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ•°æ®è¿ç§»å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
      max-width: 600px;
      width: 100%;
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 500;
    }
    input[type="password"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    input:focus {
      outline: none;
      border-color: #667eea;
    }
    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    #result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      display: none;
    }
    #result.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    #result.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .progress {
      margin-top: 20px;
      display: none;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s;
      width: 0%;
    }
    .progress-text {
      margin-top: 8px;
      font-size: 14px;
      color: #666;
      text-align: center;
    }
    .note {
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 13px;
    }
    .note strong {
      display: block;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ æ•°æ®è¿ç§»å·¥å…·</h1>
    <p class="subtitle">å°† data.backup.js æ•°æ®è¿ç§»åˆ° D1 æ•°æ®åº“</p>

    <div class="note">
      <strong>âš ï¸ é‡è¦æç¤º</strong>
      æ­¤å·¥å…·ä»…åœ¨é¦–æ¬¡éƒ¨ç½²æ—¶ä½¿ç”¨ã€‚å¦‚æœæ•°æ®åº“å·²æœ‰æ•°æ®ï¼Œå†æ¬¡æ‰§è¡Œä¼šè‡ªåŠ¨è·³è¿‡å·²å­˜åœ¨çš„è®°å½•ã€‚
    </div>

    <form id="migrateForm">
      <div class="form-group">
        <label for="password">ç®¡ç†å‘˜å¯†ç </label>
        <input type="password" id="password" placeholder="è¾“å…¥ä½ çš„ç§å¯†å¯†ç " required>
      </div>

      <button type="submit" id="migrateBtn">å¼€å§‹è¿ç§»</button>
    </form>

    <div class="progress" id="progress">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">å‡†å¤‡ä¸­...</div>
    </div>

    <div id="result"></div>
  </div>

  <!-- åŠ è½½å¯¼èˆªæ•°æ® -->
  <script src="/nav-data.js"></script>
  
  <script>
    const form = document.getElementById('migrateForm');
    const migrateBtn = document.getElementById('migrateBtn');
    const resultDiv = document.getElementById('result');
    const progressDiv = document.getElementById('progress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const apiUrl = window.location.origin;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const password = document.getElementById('password').value;

      // æ£€æŸ¥æ•°æ®æ˜¯å¦åŠ è½½æˆåŠŸ
      if (!window.navItemsData) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = `
          <h3>âŒ æ•°æ®åŠ è½½å¤±è´¥</h3>
          <p>æ— æ³•åŠ è½½å¯¼èˆªæ•°æ®ã€‚è¯·ç¡®è®¤ /nav-data.js æ–‡ä»¶å­˜åœ¨ã€‚</p>
        `;
        resultDiv.style.display = 'block';
        return;
      }

      // ç¦ç”¨æŒ‰é’®
      migrateBtn.disabled = true;
      migrateBtn.textContent = 'è¿ç§»ä¸­...';

      // æ˜¾ç¤ºè¿›åº¦
      progressDiv.style.display = 'block';
      resultDiv.style.display = 'none';

      try {
        // é€ä¸ªè¿ç§»æ¯ä¸ªç½‘ç«™
        let migrated = 0;
        let skipped = 0;
        let errors = 0;

        const totalItems = window.navItemsData.reduce((sum, cat) => sum + cat.items.length, 0);

        for (const category of window.navItemsData) {
          for (const item of category.items) {
            try {
              const response = await fetch(`${apiUrl}/api/websites/add`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${password}`
                },
                body: JSON.stringify({
                  name: item.name,
                  url: item.url,
                  category: category.category,
                  desc: item.desc || '',
                  iconUrl: item.iconUrl || '',
                  lanUrl: item.lanUrl || null,
                  darkIcon: item.darkIcon || false
                })
              });

              if (response.ok) {
                const data = await response.json();
                if (data.success) {
                  migrated++;
                }
              } else if (response.status === 409) {
                // 409 Conflict - ç½‘å€å·²å­˜åœ¨
                skipped++;
              } else if (response.status === 401) {
                throw new Error('å¯†ç é”™è¯¯ï¼Œè¯·æ£€æŸ¥ç¯å¢ƒå˜é‡ PRIVATE_PASSWORD');
              } else {
                errors++;
              }

              // æ›´æ–°è¿›åº¦
              const progress = Math.round(((migrated + skipped + errors) / totalItems) * 100);
              progressFill.style.width = `${progress}%`;
              progressText.textContent = `è¿›åº¦: ${migrated + skipped + errors}/${totalItems} (${progress}%)`;

              // é¿å…è¯·æ±‚è¿‡å¿«
              await new Promise(resolve => setTimeout(resolve, 100));

            } catch (error) {
              console.error(`è¿ç§»å¤±è´¥: ${item.name}`, error);
              errors++;
            }
          }
        }

        // æ˜¾ç¤ºç»“æœ
        resultDiv.className = errors > 0 ? 'error' : 'success';
        resultDiv.innerHTML = `
          <h3>${errors > 0 ? 'âš ï¸ è¿ç§»å®Œæˆï¼ˆæœ‰é”™è¯¯ï¼‰' : 'âœ… è¿ç§»æˆåŠŸ'}</h3>
          <p><strong>æ–°å¢:</strong> ${migrated} æ¡</p>
          <p><strong>è·³è¿‡:</strong> ${skipped} æ¡ï¼ˆå·²å­˜åœ¨ï¼‰</p>
          <p><strong>é”™è¯¯:</strong> ${errors} æ¡</p>
          <p><strong>æ€»è®¡:</strong> ${migrated + skipped} æ¡</p>
          ${errors > 0 ? '<p style="margin-top: 10px; font-size: 12px;">éƒ¨åˆ†æ•°æ®è¿ç§»å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯</p>' : ''}
        `;
        resultDiv.style.display = 'block';

      } catch (error) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = `
          <h3>âŒ è¿ç§»å¤±è´¥</h3>
          <p>${error.message}</p>
        `;
        resultDiv.style.display = 'block';
      } finally {
        migrateBtn.disabled = false;
        migrateBtn.textContent = 'é‡æ–°è¿ç§»';
        progressText.textContent = 'è¿ç§»å®Œæˆï¼';
      }
    });
  </script>
</body>
</html>
