<template>
  <div class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 relative overflow-hidden flex flex-col">
    
    <!-- âœ… è¿™é‡Œæ˜¯ä½ çš„æ˜Ÿç©ºèƒŒæ™¯å›¾ (bg.jpg å¿…é¡»åœ¨ public æ–‡ä»¶å¤¹å†…) -->
    <!-- mix-blend-overlay è®©å›¾ç‰‡å’Œåº•ä¸‹çš„ç´«è‰²æ··åˆï¼Œæ•ˆæœæ›´æ¢¦å¹» -->
    <div class="fixed inset-0 bg-[url('/bg.jpg')] bg-cover bg-center opacity-40 mix-blend-overlay pointer-events-none"></div>
    
    <!-- è¿™ä¸€å±‚æ˜¯åŠ æ·±é®ç½©ï¼Œé˜²æ­¢èƒŒæ™¯å¤ªäº®å¯¼è‡´æ–‡å­—çœ‹ä¸æ¸… -->
    <div class="fixed inset-0 bg-black/10 pointer-events-none"></div>
    
    <div class="relative z-10 flex-1 flex flex-col items-center py-4 sm:py-8 px-2 sm:px-4">
      
      <!-- 1. é¡¶éƒ¨å¯¼èˆªæ  -->
      <header class="w-full max-w-6xl mb-4 sm:mb-6 z-20 relative">
        <div class="flex justify-between items-center mb-3 px-2">
          <!-- å·¦ä¾§æŒ‰é’®ç»„ -->
          <div class="flex gap-2">
            <!-- äº‘åŒæ­¥æŒ‰é’®ï¼ˆä»…å›¾æ ‡ï¼‰ -->
            <button
              @click="showSyncModal = true"
              class="p-1.5 rounded-full transition-all duration-300 border backdrop-blur-md inline-flex items-center justify-center bg-gradient-to-r from-blue-600/80 to-cyan-600/80 border-blue-500/50 text-white hover:shadow-lg hover:shadow-blue-500/30 hover:scale-110"
              title="äº‘åŒæ­¥"
            >
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
              </svg>
            </button>

            <!-- ä¸»é¢˜è®¾ç½®æŒ‰é’® -->
            <button
              @click="showThemeModal = true"
              class="p-1.5 rounded-full transition-all duration-300 border backdrop-blur-md inline-flex items-center justify-center bg-gradient-to-r from-purple-600/80 to-pink-600/80 border-purple-500/50 text-white hover:shadow-lg hover:shadow-purple-500/30 hover:scale-110"
              title="ä¸»é¢˜è®¾ç½®"
            >
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
              </svg>
            </button>

            <!-- ç¼–è¾‘åˆ†ç±»æŒ‰é’® -->
            <button
              @click="toggleCategoryEditMode"
              class="p-1.5 rounded-full transition-all duration-300 border backdrop-blur-md inline-flex items-center justify-center"
              :class="isCategoryEditModeActive
                ? 'bg-gradient-to-r from-orange-600/80 to-red-600/80 border-orange-500/50 text-white hover:shadow-lg hover:shadow-orange-500/30'
                : 'bg-white/10 border-white/20 text-gray-400 hover:bg-white/20 hover:text-white'"
              :title="isCategoryEditModeActive ? 'å®Œæˆç¼–è¾‘åˆ†ç±»' : 'ç¼–è¾‘åˆ†ç±»é¡ºåº'"
            >
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" />
              </svg>
            </button>
          </div>

          <!-- åŒæ­¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
          <div v-if="syncStatus" class="text-[10px] sm:text-xs" :class="syncStatus.type === 'success' ? 'text-green-400' : 'text-red-400'">
            {{ syncStatus.message }}
          </div>
        </div>

        <nav class="flex justify-center px-1">
          <div class="flex flex-wrap justify-center gap-1 sm:gap-1.5 pb-1">
            <!-- å¸¸ç”¨æŒ‰é’® -->
            <button
              @click="activeCategory = 'frequent'"
              class="px-2 sm:px-3 py-1 sm:py-1 rounded-full text-[10px] sm:text-xs font-medium transition-all duration-300 border backdrop-blur-md"
              :class="activeCategory === 'frequent'
                ? 'bg-purple-600 border-purple-500 text-white shadow-lg shadow-purple-500/30 scale-105'
                : 'bg-white/5 border-white/10 text-gray-400 hover:bg-white/10 hover:text-white hover:border-white/30'"
            >
              å¸¸ç”¨
            </button>

            <!-- æˆ‘çš„æ”¶è—æŒ‰é’® -->
            <button
              @click="activeCategory = 'favorites'"
              class="px-2 sm:px-3 py-1 sm:py-1 rounded-full text-[10px] sm:text-xs font-medium transition-all duration-300 border backdrop-blur-md flex items-center gap-0.5"
              :class="activeCategory === 'favorites'
                ? 'bg-gradient-to-r from-pink-600 to-purple-600 border-pink-500 text-white shadow-lg shadow-pink-500/30 scale-105'
                : 'bg-white/5 border-white/10 text-gray-400 hover:bg-white/10 hover:text-white hover:border-white/30'"
            >
              <svg class="w-3 h-3" :class="activeCategory === 'favorites' ? 'fill-current' : 'fill-none'" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
              </svg>
              æˆ‘çš„æ”¶è—
            </button>

            <!-- åˆ†ç±»æŒ‰é’®ï¼ˆæ”¯æŒæ‹–æ‹½æ’åºã€ç¼–è¾‘å’Œåˆ é™¤ï¼‰ -->
            <button
              v-for="(item, index) in sortedNavItems"
              :key="item.category"
              :draggable="isCategoryEditModeActive"
              @dragstart="onCategoryDragStart($event, index)"
              @dragend="onCategoryDragEnd"
              @dragover.prevent="onCategoryDragOver"
              @dragenter="onCategoryDragEnter($event, index)"
              @dragleave="onCategoryDragLeave"
              @drop="onCategoryDrop($event, index)"
              @click="handleCategoryClick(item)"
              class="px-2 sm:px-3 py-1 sm:py-1 rounded-full text-[10px] sm:text-xs font-medium transition-all duration-300 border backdrop-blur-md inline-flex items-center justify-center gap-0.5 whitespace-nowrap relative"
              :style="isCategoryEditModeActive ? 'cursor: grab; transition: all 0.2s;' : ''"
              :class="[
                activeCategory === item.category
                  ? (item.category === 'ç§å¯†' ? 'bg-gradient-to-r from-red-600 to-orange-600 border-red-500' : 'bg-purple-600 border-purple-500')
                  : 'bg-white/5 border-white/10',
                activeCategory === item.category
                  ? 'text-white shadow-lg scale-105 ' + (item.category === 'ç§å¯†' ? 'shadow-red-500/30' : 'shadow-purple-500/30')
                  : 'text-gray-400 hover:bg-white/10 hover:text-white hover:border-white/30',
                draggingCategoryIndex === index ? 'opacity-30 scale-95' : ''
              ]"
            >
              <svg v-if="isCategoryEditModeActive" class="w-2.5 h-2.5 mr-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" />
              </svg>
              <svg v-if="item.category === 'ç§å¯†'" class="w-3 h-3 flex-shrink-0" :class="activeCategory === item.category ? 'fill-current' : 'fill-none'" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
              <span>{{ item.category }}</span>

              <!-- ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®ï¼ˆä»…åœ¨ç¼–è¾‘æ¨¡å¼æ˜¾ç¤ºï¼‰ -->
              <template v-if="isCategoryEditModeActive">
                <button
                  @click.stop="editCategory(item.category)"
                  @mousedown.stop
                  class="ml-1 p-0.5 rounded-full hover:bg-white/20 transition-colors"
                  title="é‡å‘½ååˆ†ç±»"
                  style="pointer-events: auto; cursor: pointer;"
                >
                  <svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                </button>
                <button
                  @click.stop="deleteCategory(item.category)"
                  @mousedown.stop
                  class="ml-0.5 p-0.5 rounded-full hover:bg-red-500/30 transition-colors text-red-400"
                  title="åˆ é™¤åˆ†ç±»"
                  style="pointer-events: auto; cursor: pointer;"
                >
                  <svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </template>
            </button>

            <!-- æ–°å»ºåˆ†ç±»æŒ‰é’®ï¼ˆä»…åœ¨ç¼–è¾‘æ¨¡å¼æ˜¾ç¤ºï¼‰ -->
            <button
              v-if="isCategoryEditModeActive"
              @click="createNewCategory"
              class="px-2 sm:px-3 py-1 sm:py-1 rounded-full text-[10px] sm:text-xs font-medium transition-all duration-300 border backdrop-blur-md inline-flex items-center justify-center gap-0.5 whitespace-nowrap border-dashed border-green-500/50 text-green-400 hover:bg-green-500/20 hover:border-green-500"
            >
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              <span>æ–°å»º</span>
            </button>
          </div>
        </nav>
      </header>

      <!-- 2. æœç´¢æ¡† -->
      <div class="relative w-full max-w-2xl mx-auto mb-6 sm:mb-8 group z-50 px-2">
        <div class="absolute -inset-0.5 bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl sm:rounded-2xl opacity-30 blur transition duration-1000 group-hover:opacity-75 group-hover:duration-200"></div>
        <div class="relative flex items-center bg-gray-900/80 backdrop-blur-xl border border-white/10 rounded-xl sm:rounded-2xl p-1.5 sm:p-2 transition-colors focus-within:bg-gray-800/90 focus-within:border-white/20">
          <div class="relative">
            <button
              @click.stop="showEngineList = !showEngineList"
              class="flex items-center gap-1.5 sm:gap-2 px-2 sm:px-3 py-1.5 sm:py-2 text-gray-300 hover:text-white hover:bg-white/10 rounded-lg sm:rounded-xl transition-all"
            >
              <span class="font-bold text-purple-400 text-xs sm:text-sm">{{ currentEngine.name }}</span>
              <svg class="w-2.5 h-2.5 sm:w-3 sm:h-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div v-if="showEngineList" class="absolute top-full left-0 mt-2 w-32 bg-gray-800 border border-white/10 rounded-xl shadow-xl overflow-hidden">
              <div
                v-for="(engine, index) in searchEngines"
                :key="index"
                @click="switchEngine(engine)"
                class="px-3 sm:px-4 py-2 sm:py-3 cursor-pointer hover:bg-purple-600 hover:text-white text-gray-400 text-xs sm:text-sm transition-colors"
                :class="{'text-white bg-white/10': currentEngine.name === engine.name}"
              >
                {{ engine.name }}
              </div>
            </div>
          </div>
          <input
            v-model="searchQuery"
            @keypress.enter="handleSearch"
            type="text"
            :placeholder="`åœ¨ ${currentEngine.name} ä¸­æœç´¢...`"
            class="flex-1 w-full bg-transparent text-white placeholder-gray-500 px-2 sm:px-4 py-1.5 sm:py-2 focus:outline-none text-sm sm:text-base"
          />
          <button
            @click="handleSearch"
            class="hidden sm:flex px-4 sm:px-6 py-1.5 sm:py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-xl transition-all font-medium items-center gap-2 shadow-lg shadow-purple-900/20 text-sm"
          >
            æœç´¢
          </button>
        </div>
      </div>
      <div v-if="showEngineList" @click="showEngineList = false" class="fixed inset-0 z-40 bg-transparent cursor-default"></div>

      <!-- 3. å†…å®¹ç½‘æ ¼ -->
      <div v-if="draggablesList.length > 0" class="w-full max-w-[64rem] grid grid-cols-4 md:grid-cols-7 xl:grid-cols-9 gap-1.5 px-1 sm:px-2 pb-8 mx-auto">
        <draggable
          v-model="draggablesList"
          item-key="id"
          :disabled="!enableDrag || !isDragModeActive"
          @end="(evt) => onDragEnd(evt, activeCategory)"
          class="contents"
          :animation="300"
          ghost-class="ghost-card"
          drag-class="dragging-card"
          chosen-class="chosen-card"
        >
          <template #item="{ element: item }">
            <NavCard
              :key="item.id || item.url"
              :item="item"
              :on-click="recordClick"
              :is-favorite="isFavorite(item)"
              :last-visit="lastVisitTime(item.url)"
              @toggle-favorite="toggleFavorite"
              @record-visit="recordVisit"
            />
          </template>
        </draggable>
      </div>

      <!-- æ‹–æ‹½æ§åˆ¶æŒ‰é’®ï¼ˆä»…åœ¨å¯ç”¨æ‹–æ‹½æ—¶æ˜¾ç¤ºï¼‰ -->
      <div v-if="enableDrag && draggablesList.length > 0" class="fixed bottom-20 right-4 z-30">
        <button
          @click="toggleDragMode"
          class="p-3 rounded-full transition-all duration-300 border backdrop-blur-md inline-flex items-center justify-center shadow-lg hover:shadow-xl"
          :class="isDragModeActive
            ? 'bg-gradient-to-r from-green-600/90 to-emerald-600/90 border-green-500/50 text-white hover:scale-110'
            : 'bg-gradient-to-r from-purple-600/90 to-pink-600/90 border-purple-500/50 text-white hover:scale-110'"
          :title="isDragModeActive ? 'ç‚¹å‡»å®Œæˆæ‹–æ‹½' : 'ç‚¹å‡»å¼€å§‹æ‹–æ‹½'"
        >
          <svg v-if="!isDragModeActive" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l4-4" />
          </svg>
          <svg v-else class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        </button>
      </div>
    </div>

    <!-- 4. åº•éƒ¨ Footer (ä¿®æ”¹äº†è¿™é‡Œ) -->
    <footer class="relative z-10 w-full py-6 text-center">
      <div class="flex items-center justify-center gap-4 text-sm text-gray-500">
        <!-- å‹æƒ…é“¾æ¥æŒ‰é’® -->
        <button 
          @click="showFriendModal = true"
          class="flex items-center gap-1 hover:text-purple-400 transition-colors cursor-pointer"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
          å‹æƒ…é“¾æ¥
        </button>
        
        <span class="opacity-30">|</span>
        
        <!-- ç‰ˆæƒæ–‡å­— (æ”¹æˆäº†ä½ çš„ç§äººå¯¼èˆª) -->
        <span>Copyright Â© 2025 <span class="text-gray-300">æˆ‘çš„ç§äººå¯¼èˆª</span></span>
      </div>
    </footer>

    <!-- 5. å‹æƒ…é“¾æ¥å¼¹çª— -->
    <div v-if="showFriendModal" class="fixed inset-0 z-50 flex items-center justify-center p-4" @click.self="showFriendModal = false">
      <div class="absolute inset-0 bg-black/70 backdrop-blur-md"></div>

      <div class="relative bg-gradient-to-br from-gray-800/95 to-gray-900/95 border border-white/10 rounded-3xl shadow-2xl p-5 w-full max-w-md transform transition-all">
        <!-- å…‰æ•ˆèƒŒæ™¯ -->
        <div class="absolute inset-0 bg-gradient-to-br from-purple-600/10 via-transparent to-pink-600/10 rounded-3xl pointer-events-none"></div>

        <div class="relative z-10">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-white flex items-center gap-2">
              <span class="w-1 h-6 bg-gradient-to-b from-purple-500 to-pink-500 rounded-full shadow-lg shadow-purple-500/50"></span>
              å‹æƒ…é“¾æ¥
            </h3>
            <button @click="showFriendModal = false" class="text-gray-400 hover:text-white transition-colors p-2 hover:bg-white/5 rounded-xl">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
          </div>

          <div class="grid grid-cols-3 sm:grid-cols-4 gap-1">
            <a
              v-for="(link, index) in friendLinks"
              :key="index"
              :href="link.url"
              target="_blank"
              class="group relative flex flex-col items-center py-1 px-0.5 rounded-xl bg-gray-700/30 hover:bg-purple-600/20 border border-white/5 hover:border-purple-400/40 transition-all duration-300 hover:shadow-lg hover:shadow-purple-500/20 hover:-translate-y-1 overflow-hidden"
            >
              <!-- æ‚¬åœèƒŒæ™¯å…‰æ•ˆ -->
              <div class="absolute inset-0 bg-gradient-to-br from-purple-600/0 to-pink-600/0 group-hover:from-purple-600/10 group-hover:to-pink-600/10 transition-all duration-500"></div>

              <!-- å›¾æ ‡å®¹å™¨ -->
              <div class="relative mb-1">
                <div class="absolute inset-0 bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-xl blur-lg opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                <div class="relative flex h-10 w-10 items-center justify-center transition-transform duration-300 group-hover:scale-110">
                  <img
                    :src="getIconSrc(link)"
                    @error="handleImageError"
                    class="h-full w-full object-contain rounded-xl drop-shadow-md"
                  />
                </div>
              </div>

              <span class="relative z-10 text-[10px] font-medium text-gray-300 group-hover:text-white transition-colors truncate w-full text-center">{{ link.name }}</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- 6. å¯†ç éªŒè¯å¼¹çª— -->
    <div v-if="showPasswordModal" class="fixed inset-0 z-50 flex items-center justify-center p-4" @click.self="cancelPassword">
      <div class="absolute inset-0 bg-black/70 backdrop-blur-md"></div>

      <div class="relative bg-gradient-to-br from-gray-800/95 to-gray-900/95 border border-white/10 rounded-3xl shadow-2xl p-8 w-full max-w-md transform transition-all">
        <!-- å…‰æ•ˆèƒŒæ™¯ -->
        <div class="absolute inset-0 bg-gradient-to-br from-red-600/10 via-transparent to-orange-600/10 rounded-3xl pointer-events-none"></div>

        <div class="relative z-10">
          <div class="flex justify-between items-center mb-8">
            <h3 class="text-2xl font-bold text-white flex items-center gap-3">
              <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
              å¯†ç éªŒè¯
            </h3>
            <button @click="cancelPassword" class="text-gray-400 hover:text-white transition-colors p-2 hover:bg-white/5 rounded-xl">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
          </div>

          <p class="text-gray-400 text-sm mb-6">è¯·è¾“å…¥å¯†ç ä»¥è®¿é—®ç§å¯†åˆ†ç±»</p>

          <div class="space-y-4">
            <input
              v-model="passwordInput"
              @keypress.enter="verifyPassword"
              type="password"
              placeholder="è¯·è¾“å…¥å¯†ç "
              class="w-full px-4 py-3 bg-gray-700/50 border border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-red-400/50 focus:ring-2 focus:ring-red-400/20 transition-all"
              autofocus
            />

            <p v-if="passwordError" class="text-red-400 text-sm">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</p>

            <div class="flex gap-3">
              <button
                @click="cancelPassword"
                class="flex-1 px-4 py-3 bg-gray-700/50 hover:bg-gray-700 text-gray-300 rounded-xl transition-colors"
              >
                å–æ¶ˆ
              </button>
              <button
                @click="verifyPassword"
                class="flex-1 px-4 py-3 bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 text-white rounded-xl transition-all shadow-lg shadow-red-500/30 hover:shadow-red-500/50 font-medium"
              >
                ç¡®è®¤
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 7. äº‘åŒæ­¥å¼¹çª— -->
    <div v-if="showSyncModal" class="fixed inset-0 z-50 flex items-center justify-center p-4" @click.self="showSyncModal = false">
      <div class="absolute inset-0 bg-black/70 backdrop-blur-md"></div>

      <div class="relative bg-gradient-to-br from-gray-800/95 to-gray-900/95 border border-white/10 rounded-3xl shadow-2xl p-8 w-full max-w-md transform transition-all">
        <!-- å…‰æ•ˆèƒŒæ™¯ -->
        <div class="absolute inset-0 bg-gradient-to-br from-blue-600/10 via-transparent to-cyan-600/10 rounded-3xl pointer-events-none"></div>

        <div class="relative z-10">
          <div class="flex justify-between items-center mb-8">
            <h3 class="text-2xl font-bold text-white flex items-center gap-3">
              <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
              </svg>
              äº‘åŒæ­¥
            </h3>
            <button @click="showSyncModal = false" class="text-gray-400 hover:text-white transition-colors p-2 hover:bg-white/5 rounded-xl">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
          </div>

          <!-- ç”¨æˆ· ID æ˜¾ç¤º -->
          <div class="mb-6 p-4 bg-gray-700/30 rounded-xl border border-white/5">
            <div class="flex justify-between items-center mb-2">
              <p class="text-gray-400 text-xs">ä½ çš„åŒæ­¥ ID</p>
              <button
                v-if="!isEditingId"
                @click="startEditId"
                class="text-[10px] text-blue-400 hover:text-blue-300 transition-colors flex items-center gap-1"
              >
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                ä¿®æ”¹
              </button>
            </div>

            <!-- æ˜¾ç¤ºæ¨¡å¼ -->
            <div v-if="!isEditingId" class="flex items-center gap-2">
              <code class="flex-1 text-sm text-blue-400 bg-gray-900/50 px-3 py-2 rounded-lg break-all">{{ syncAuthToken }}</code>
              <button
                @click="copyAuthToken"
                class="p-2 hover:bg-white/10 rounded-lg transition-colors"
                title="å¤åˆ¶"
              >
                <svg class="w-5 h-5 text-gray-400 hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
              </button>
            </div>

            <!-- ç¼–è¾‘æ¨¡å¼ -->
            <div v-else class="space-y-2">
              <input
                v-model="editingId"
                type="text"
                class="w-full px-3 py-2 text-sm text-blue-400 bg-gray-900/50 border border-blue-500/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/50 placeholder-gray-500"
                placeholder="è¾“å…¥æ–°çš„åŒæ­¥ ID"
                @keyup.enter="saveId"
                @keyup.esc="cancelEditId"
              >
              <div class="flex gap-2">
                <button
                  @click="saveId"
                  class="flex-1 px-3 py-1.5 text-xs bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-colors"
                >
                  ä¿å­˜
                </button>
                <button
                  @click="cancelEditId"
                  class="flex-1 px-3 py-1.5 text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg transition-colors"
                >
                  å–æ¶ˆ
                </button>
              </div>
            </div>
          </div>

          <!-- åŒæ­¥æŒ‰é’® -->
          <div class="space-y-3">
            <button
              @click="syncToCloud"
              :disabled="isSyncing"
              class="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 text-white rounded-xl transition-all shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 font-medium flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
              </svg>
              {{ isSyncing ? 'åŒæ­¥ä¸­...' : 'ä¸Šä¼ åˆ°äº‘ç«¯' }}
            </button>

            <button
              @click="syncFromCloud"
              :disabled="isSyncing"
              class="w-full px-4 py-3 bg-gray-700/50 hover:bg-gray-700 text-gray-300 rounded-xl transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3-3m0 0l3 3m-3-3v12" />
              </svg>
              {{ isSyncing ? 'ä¸‹è½½ä¸­...' : 'ä»äº‘ç«¯æ¢å¤' }}
            </button>
          </div>

          <p class="mt-4 text-center text-gray-500 text-xs">
            ä½¿ç”¨ç›¸åŒ ID å¯åœ¨å¤šè®¾å¤‡é—´åŒæ­¥æ•°æ®
          </p>
        </div>
      </div>
    </div>

    <!-- 8. ä¸»é¢˜è®¾ç½®å¼¹çª— -->
    <ThemeModal :show="showThemeModal" @close="showThemeModal = false" />

  </div>
</template>

<script setup>
import { ref, computed, onMounted, watch } from 'vue'
import draggable from 'vuedraggable'
// âœ… å¼•å…¥æœç´¢å¼•æ“å’Œå‹æƒ…é“¾æ¥
import { fetchNavItems, searchEngines, friendLinks } from './data'
import NavCard from './components/NavCard.vue'
import ThemeModal from './components/ThemeModal.vue'
import { useTheme } from './composables/useTheme'

// åˆå§‹åŒ–ä¸»é¢˜ç³»ç»Ÿ
const { settings: themeSettings } = useTheme()

// === çŠ¶æ€å®šä¹‰ ===
const navItems = ref([])  // æ”¹ä¸ºå“åº”å¼æ•°ç»„
const activeCategory = ref('frequent')
const searchQuery = ref('')
const showEngineList = ref(false)
const showFriendModal = ref(false) // æ§åˆ¶å‹é“¾å¼¹çª—
const showPasswordModal = ref(false) // æ§åˆ¶å¯†ç å¼¹çª—
const showSyncModal = ref(false) // æ§åˆ¶åŒæ­¥å¼¹çª—
const showThemeModal = ref(false) // æ§åˆ¶ä¸»é¢˜å¼¹çª—
const passwordInput = ref('') // å¯†ç è¾“å…¥
const passwordError = ref(false) // å¯†ç é”™è¯¯æç¤º
const isPrivateUnlocked = ref(false) // ç§å¯†åˆ†ç±»æ˜¯å¦å·²è§£é”
const currentEngine = ref(searchEngines[0])

// === äº‘åŒæ­¥çŠ¶æ€ ===
const API_BASE = import.meta.env.VITE_SYNC_API || '' // ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ŒæŒ‡å‘ Pages Functions
const syncAuthToken = ref(localStorage.getItem('syncAuthToken') || generateDeviceId())
const isSyncing = ref(false)
const syncStatus = ref(null)

// === ç”¨æˆ·ç™»å½•çŠ¶æ€ ===
const isLoggedIn = ref(!!localStorage.getItem('userToken'))  // æ˜¯å¦å·²ç™»å½•
const currentUser = ref(JSON.parse(localStorage.getItem('currentUser') || 'null'))  // å½“å‰ç”¨æˆ·ä¿¡æ¯
const userToken = ref(localStorage.getItem('userToken') || '')  // ç”¨æˆ· token

// ç™»å½•è¡¨å•çŠ¶æ€
const loginUsername = ref('')
const loginPassword = ref('')
const registerUsername = ref('')
const registerPassword = ref('')
const authMode = ref('login')  // 'login' æˆ– 'register'
const authError = ref('')
const authLoading = ref(false)

// === æ‹–æ‹½æ¨¡å¼æ§åˆ¶ ===
const isDragModeActive = ref(false) // æ‹–æ‹½æ¨¡å¼æ˜¯å¦æ¿€æ´»

// === åˆ†ç±»ç¼–è¾‘æ¨¡å¼ ===
const isCategoryEditModeActive = ref(false) // åˆ†ç±»ç¼–è¾‘æ¨¡å¼æ˜¯å¦æ¿€æ´»
const categoryOrder = ref([]) // åˆ†ç±»è‡ªå®šä¹‰é¡ºåº
const draggingCategoryIndex = ref(-1) // æ­£åœ¨æ‹–æ‹½çš„åˆ†ç±»ç´¢å¼•
const draggedCategoryName = ref('') // æ­£åœ¨æ‹–æ‹½çš„åˆ†ç±»åç§°
const tempCategoryOrder = ref([]) // æ‹–æ‹½è¿‡ç¨‹ä¸­çš„ä¸´æ—¶é¡ºåº

// åˆ‡æ¢åˆ†ç±»ç¼–è¾‘æ¨¡å¼
const toggleCategoryEditMode = () => {
  isCategoryEditModeActive.value = !isCategoryEditModeActive.value
  if (!isCategoryEditModeActive.value) {
    // é€€å‡ºç¼–è¾‘æ¨¡å¼æ—¶ä¿å­˜é¡ºåº
    saveCategoryOrder()
    // è‡ªåŠ¨è§¦å‘äº‘åŒæ­¥ï¼ˆä» localStorage è¯»å–æœ€æ–°å€¼ï¼‰
    syncToCloud()
  }
}

// å¤„ç†åˆ†ç±»æŒ‰é’®ç‚¹å‡»
const handleCategoryClick = (item) => {
  if (isCategoryEditModeActive.value) {
    // ç¼–è¾‘æ¨¡å¼ä¸‹ä¸åˆ‡æ¢åˆ†ç±»
    return
  }

  if (item.category === 'ç§å¯†') {
    showPasswordModal.value = true
  } else {
    activeCategory.value = item.category
  }
}

// é‡å‘½ååˆ†ç±»
const editCategory = async (oldName) => {
  const newName = prompt(`è¯·è¾“å…¥ã€Œ${oldName}ã€çš„æ–°åç§°ï¼š`, oldName)

  if (!newName || newName === oldName) {
    return
  }

  try {
    const response = await fetch('/api/categories/rename', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼š')}`
      },
      body: JSON.stringify({ oldName, newName })
    })

    const result = await response.json()

    if (response.ok && result.success) {
      alert(result.message)
      // é‡æ–°åŠ è½½æ•°æ®
      location.reload()
    } else {
      alert('é‡å‘½åå¤±è´¥ï¼š' + (result.error || result.message))
    }
  } catch (error) {
    alert('é‡å‘½åå¤±è´¥ï¼š' + error.message)
  }
}

// åˆ é™¤åˆ†ç±»
const deleteCategory = async (categoryName) => {
  const confirmed = confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç±»ã€Œ${categoryName}ã€å—ï¼Ÿ\n\næ³¨æ„ï¼šè¿™å°†åˆ é™¤è¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰ç½‘ç«™ï¼`)

  if (!confirmed) {
    return
  }

  try {
    const response = await fetch('/api/categories/delete', {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼š')}`
      },
      body: JSON.stringify({ name: categoryName })
    })

    const result = await response.json()

    if (response.ok && result.success) {
      alert(result.message)
      // é‡æ–°åŠ è½½æ•°æ®
      location.reload()
    } else {
      alert('åˆ é™¤å¤±è´¥ï¼š' + (result.error || result.message))
    }
  } catch (error) {
    alert('åˆ é™¤å¤±è´¥ï¼š' + error.message)
  }
}

// æ–°å»ºåˆ†ç±»
const createNewCategory = async () => {
  const name = prompt('è¯·è¾“å…¥æ–°åˆ†ç±»çš„åç§°ï¼š')

  if (!name || !name.trim()) {
    return
  }

  try {
    const response = await fetch('/api/categories/create', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼š')}`
      },
      body: JSON.stringify({ name: name.trim() })
    })

    const result = await response.json()

    if (response.ok && result.success) {
      alert(result.message)
      // é‡æ–°åŠ è½½æ•°æ®
      location.reload()
    } else {
      alert('åˆ›å»ºå¤±è´¥ï¼š' + (result.error || result.message))
    }
  } catch (error) {
    alert('åˆ›å»ºå¤±è´¥ï¼š' + error.message)
  }
}

// ä¿å­˜åˆ†ç±»é¡ºåº
const saveCategoryOrder = () => {
  // ä¼˜å…ˆä½¿ç”¨ tempCategoryOrderï¼ˆç¡®ä¿è·å–æœ€æ–°çš„æ‹–æ‹½é¡ºåºï¼‰
  const orderToSave = tempCategoryOrder.value.length > 0
    ? tempCategoryOrder.value
    : categoryOrder.value

  console.log('ä¿å­˜åˆ†ç±»é¡ºåºåˆ° localStorage:', orderToSave)

  // ä¿å­˜åˆ° localStorage
  localStorage.setItem('navCategoryOrder', JSON.stringify(orderToSave))
}

// æŒ‰ç…§è‡ªå®šä¹‰é¡ºåºæ’åºåˆ†ç±»
const sortedNavItems = computed(() => {
  // å¦‚æœæ­£åœ¨æ‹–æ‹½ï¼Œä½¿ç”¨ä¸´æ—¶é¡ºåº
  const order = (isCategoryEditModeActive.value && tempCategoryOrder.value.length > 0)
    ? tempCategoryOrder.value
    : categoryOrder.value

  const items = navItems.value
  if (order.length === 0) {
    return items
  }

  // åˆ›å»ºæ’åºåçš„æ•°ç»„
  const sorted = []
  const ordered = new Set(order)
  const remaining = []

  // å…ˆæŒ‰ç…§è‡ªå®šä¹‰é¡ºåºæ’åˆ—
  order.forEach(cat => {
    const found = items.find(item => item.category === cat)
    if (found) sorted.push(found)
  })

  // ç„¶åæ·»åŠ æœªæ’åºçš„åˆ†ç±»
  items.forEach(item => {
    if (!ordered.has(item.category)) {
      remaining.push(item)
    }
  })

  return [...sorted, ...remaining]
})

// åˆ†ç±»æ‹–æ‹½å¼€å§‹
const onCategoryDragStart = (event, index) => {
  console.log('æ‹–æ‹½å¼€å§‹:', index, sortedNavItems.value[index]?.category)
  draggingCategoryIndex.value = index
  draggedCategoryName.value = sortedNavItems.value[index].category

  // åˆ›å»ºä¸´æ—¶é¡ºåºçš„å‰¯æœ¬
  tempCategoryOrder.value = sortedNavItems.value.map(item => item.category)

  // è®¾ç½®æ‹–æ‹½æ•°æ®
  event.dataTransfer.effectAllowed = 'move'
  event.dataTransfer.setData('text/plain', index.toString())

  // æ·»åŠ æ‹–æ‹½è§†è§‰åé¦ˆ
  setTimeout(() => {
    if (event.target) {
      event.target.style.opacity = '0.4'
      event.target.style.transform = 'scale(0.95)'
    }
  }, 0)

  console.log('ä¸´æ—¶é¡ºåº:', tempCategoryOrder.value)
}

// åˆ†ç±»æ‹–æ‹½ç»“æŸ
const onCategoryDragEnd = (event) => {
  console.log('æ‹–æ‹½ç»“æŸï¼Œåº”ç”¨é¡ºåº:', tempCategoryOrder.value)

  // æ¢å¤æ ·å¼
  if (event.target) {
    event.target.style.opacity = ''
    event.target.style.transform = ''
  }

  if (draggingCategoryIndex.value !== -1 && tempCategoryOrder.value.length > 0) {
    // åº”ç”¨ä¸´æ—¶é¡ºåº
    categoryOrder.value = [...tempCategoryOrder.value]
    console.log('æœ€ç»ˆä¿å­˜é¡ºåº:', categoryOrder.value)
  }

  draggingCategoryIndex.value = -1
  draggedCategoryName.value = ''
  tempCategoryOrder.value = []
}

// åˆ†ç±»æ‹–æ‹½ç»è¿‡ï¼ˆé˜»æ­¢é»˜è®¤è¡Œä¸ºä»¥å…è®¸ dropï¼‰
const onCategoryDragOver = (event) => {
  event.preventDefault()
  event.dataTransfer.dropEffect = 'move'
}

// åˆ†ç±»æ‹–æ‹½è¿›å…¥ï¼ˆç”¨äºè§†è§‰åé¦ˆï¼‰
const onCategoryDragEnter = (event, index) => {
  if (draggingCategoryIndex.value === -1 || draggingCategoryIndex.value === index) {
    return
  }

  // æ·»åŠ ç›®æ ‡ä½ç½®çš„è§†è§‰åé¦ˆ
  event.target.style.transform = 'scale(1.05)'
  event.target.style.boxShadow = '0 0 0 2px rgba(168, 85, 247, 0.5)'
  console.log('æ‹–æ‹½è¿›å…¥ç›®æ ‡:', index, 'å¯ä»¥å°†', sortedNavItems.value[draggingCategoryIndex.value]?.category, 'ç§»åŠ¨åˆ°', sortedNavItems.value[index]?.category)
}

// åˆ†ç±»æ‹–æ‹½ç¦»å¼€
const onCategoryDragLeave = (event) => {
  // æ¸…é™¤è§†è§‰åé¦ˆ
  if (event.target && draggingCategoryIndex.value !== sortedNavItems.value.findIndex(item => item.category === event.target.textContent?.trim())) {
    event.target.style.transform = ''
    event.target.style.boxShadow = ''
  }
}

// åˆ†ç±»æ”¾ä¸‹
const onCategoryDrop = (event, targetIndex) => {
  event.preventDefault()
  event.stopPropagation()

  // æ¸…é™¤ç›®æ ‡ä½ç½®çš„è§†è§‰åé¦ˆ
  if (event.target) {
    event.target.style.transform = ''
    event.target.style.boxShadow = ''
  }

  console.log('æ”¾ä¸‹åˆ°ä½ç½®:', targetIndex, 'ä»ä½ç½®:', draggingCategoryIndex.value)

  const fromIndex = draggingCategoryIndex.value
  if (fromIndex === -1 || fromIndex === targetIndex) {
    console.log('æ— æ•ˆçš„æ‹–æ‹½æ“ä½œ')
    return
  }

  // è·å–å½“å‰ä¸´æ—¶é¡ºåº
  const items = [...tempCategoryOrder.value]
  console.log('å½“å‰ä¸´æ—¶é¡ºåº:', items)

  // ç§»é™¤è¢«æ‹–æ‹½çš„å…ƒç´ 
  const draggedItem = items[fromIndex]
  items.splice(fromIndex, 1)

  // æ’å…¥åˆ°æ–°ä½ç½®ï¼ˆå…¨å±€æ‹–æ‹½ - å¯ä»¥è·¨è¶Šä»»æ„è·ç¦»ï¼‰
  items.splice(targetIndex, 0, draggedItem)

  // æ›´æ–°ä¸´æ—¶é¡ºåº
  tempCategoryOrder.value = items
  draggingCategoryIndex.value = targetIndex

  console.log('æ›´æ–°åçš„ä¸´æ—¶é¡ºåº:', tempCategoryOrder.value)
  console.log(`âœ“ å·²å°†ã€Œ${draggedItem}ã€ä»ä½ç½® ${fromIndex} ç§»åŠ¨åˆ°ä½ç½® ${targetIndex}`)
}

// åˆ‡æ¢æ‹–æ‹½æ¨¡å¼
const toggleDragMode = () => {
  isDragModeActive.value = !isDragModeActive.value
  if (!isDragModeActive.value) {
    // å®Œæˆæ‹–æ‹½ï¼Œè‡ªåŠ¨äº‘åŒæ­¥
    syncToCloud()
    // æ˜¾ç¤ºä¿å­˜æç¤º
    syncStatus.value = { type: 'success', message: 'âœ… æ‹–æ‹½æ’åºå·²ä¿å­˜å¹¶åŒæ­¥' }
    setTimeout(() => syncStatus.value = null, 2000)
  }
}

// ç”Ÿæˆè®¾å¤‡ ID
function generateDeviceId() {
  return 'device_' + Math.random().toString(36).substring(2, 15)
}

// === ç”¨æˆ·ç™»å½•ç›¸å…³å‡½æ•° ===

// ç”¨æˆ·æ³¨å†Œ
const handleRegister = async () => {
  authError.value = ''
  authLoading.value = true

  try {
    const response = await fetch('/api/auth/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        username: registerUsername.value,
        password: registerPassword.value
      })
    })

    const result = await response.json()

    if (response.ok && result.success) {
      // æ³¨å†ŒæˆåŠŸï¼Œè‡ªåŠ¨ç™»å½•
      loginUsername.value = registerUsername.value
      loginPassword.value = registerPassword.value
      await handleLogin()
    } else {
      authError.value = result.error || 'æ³¨å†Œå¤±è´¥'
    }
  } catch (error) {
    authError.value = 'ç½‘ç»œé”™è¯¯ï¼š' + error.message
  } finally {
    authLoading.value = false
  }
}

// ç”¨æˆ·ç™»å½•
const handleLogin = async () => {
  authError.value = ''
  authLoading.value = true

  try {
    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        username: loginUsername.value,
        password: loginPassword.value
      })
    })

    const result = await response.json()

    if (response.ok && result.success) {
      // ç™»å½•æˆåŠŸï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯
      userToken.value = result.token
      currentUser.value = { username: result.username, userId: result.userId }
      isLoggedIn.value = true

      localStorage.setItem('userToken', result.token)
      localStorage.setItem('currentUser', JSON.stringify({ username: result.username, userId: result.userId }))
      localStorage.setItem('syncAuthToken', result.token) // ç”¨ç”¨æˆ· token æ›¿æ¢è®¾å¤‡ ID
      syncAuthToken.value = result.token

      syncStatus.value = { type: 'success', message: `âœ… æ¬¢è¿å›æ¥ï¼Œ${result.username}ï¼` }
      setTimeout(() => syncStatus.value = null, 2000)
    } else {
      authError.value = result.error || 'ç™»å½•å¤±è´¥'
    }
  } catch (error) {
    authError.value = 'ç½‘ç»œé”™è¯¯ï¼š' + error.message
  } finally {
    authLoading.value = false
  }
}

// ç”¨æˆ·é€€å‡ºç™»å½•
const handleLogout = () => {
  isLoggedIn.value = false
  currentUser.value = null
  userToken.value = ''
  syncAuthToken.value = generateDeviceId()

  localStorage.removeItem('userToken')
  localStorage.removeItem('currentUser')
  localStorage.setItem('syncAuthToken', syncAuthToken.value)

  syncStatus.value = { type: 'success', message: 'âœ… å·²é€€å‡ºç™»å½•' }
  setTimeout(() => syncStatus.value = null, 2000)
}

// === ç‚¹å‡»ç»Ÿè®¡ ===
const DATA_VERSION = '1.0' // æ•°æ®ç‰ˆæœ¬å·
const clickCounts = ref({})
const favorites = ref(new Set())
const visitHistory = ref({})
const customOrder = ref({}) // è‡ªå®šä¹‰æ’åº {category: [id1, id2, ...]}

// ä» localStorage åŠ è½½æ•°æ®
onMounted(async () => {
  // åŠ è½½å¯¼èˆªç½‘ç«™æ•°æ®ï¼ˆä» D1 æ•°æ®åº“ï¼‰
  try {
    navItems.value = await fetchNavItems()
    console.log('âœ“ å¯¼èˆªæ•°æ®åŠ è½½å®Œæˆ')
  } catch (error) {
    console.error('âœ— å¯¼èˆªæ•°æ®åŠ è½½å¤±è´¥:', error)
  }

  const savedVersion = localStorage.getItem('navDataVersion')
  const saved = localStorage.getItem('navClickCounts')
  const savedFavorites = localStorage.getItem('navFavorites')
  const savedVisits = localStorage.getItem('navVisits')
  const savedOrder = localStorage.getItem('navCustomOrder')
  const savedCategoryOrder = localStorage.getItem('navCategoryOrder')

  // å¦‚æœç‰ˆæœ¬ä¸åŒ¹é…ï¼Œæ¸…ç†æ—§æ•°æ®
  if (savedVersion !== DATA_VERSION) {
    console.log('æ•°æ®ç‰ˆæœ¬å·²æ›´æ–°ï¼Œæ¸…ç†æ—§ç¼“å­˜æ•°æ®')
    localStorage.removeItem('navClickCounts')
    localStorage.removeItem('navFavorites')
    localStorage.removeItem('navVisits')
    localStorage.removeItem('navCustomOrder')
    localStorage.removeItem('navCategoryOrder')
    localStorage.setItem('navDataVersion', DATA_VERSION)
    clickCounts.value = {}
    favorites.value = new Set()
    visitHistory.value = {}
    customOrder.value = {}
    categoryOrder.value = []
  } else {
    // åŠ è½½ç‚¹å‡»ç»Ÿè®¡
    if (saved) {
      try {
        clickCounts.value = JSON.parse(saved)
      } catch (e) {
        console.error('Failed to parse click counts:', e)
        clickCounts.value = {}
      }
    }

    // åŠ è½½æ”¶è—åˆ—è¡¨
    if (savedFavorites) {
      try {
        const favArray = JSON.parse(savedFavorites)
        favorites.value = new Set(favArray)
      } catch (e) {
        console.error('Failed to parse favorites:', e)
        favorites.value = new Set()
      }
    }

    // åŠ è½½è®¿é—®å†å²
    if (savedVisits) {
      try {
        visitHistory.value = JSON.parse(savedVisits)
      } catch (e) {
        console.error('Failed to parse visit history:', e)
        visitHistory.value = {}
      }
    }

    // åŠ è½½è‡ªå®šä¹‰æ’åº
    if (savedOrder) {
      try {
        customOrder.value = JSON.parse(savedOrder)
      } catch (e) {
        console.error('Failed to parse custom order:', e)
        customOrder.value = {}
      }
    }

    // åŠ è½½åˆ†ç±»é¡ºåº
    if (savedCategoryOrder) {
      try {
        categoryOrder.value = JSON.parse(savedCategoryOrder)
      } catch (e) {
        console.error('Failed to parse category order:', e)
        categoryOrder.value = []
      }
    }
  }
})

// è®°å½•ç‚¹å‡»
const recordClick = (item) => {
  const key = item.url
  clickCounts.value[key] = (clickCounts.value[key] || 0) + 1
  localStorage.setItem('navClickCounts', JSON.stringify(clickCounts.value))
}

// è®°å½•è®¿é—®æ—¶é—´
const recordVisit = (item) => {
  const key = item.url
  visitHistory.value[key] = new Date().toISOString()
  localStorage.setItem('navVisits', JSON.stringify(visitHistory.value))
}

// è·å–æœ€åè®¿é—®æ—¶é—´
const lastVisitTime = (url) => {
  return visitHistory.value[url] || null
}

// åˆ¤æ–­æ˜¯å¦æ”¶è—
const isFavorite = (item) => {
  return favorites.value.has(item.url || item.id)
}

// åˆ‡æ¢æ”¶è—çŠ¶æ€
const toggleFavorite = (item) => {
  const key = item.url || item.id
  if (favorites.value.has(key)) {
    favorites.value.delete(key)
  } else {
    favorites.value.add(key)
  }
  // ä¿å­˜åˆ° localStorage
  localStorage.setItem('navFavorites', JSON.stringify([...favorites.value]))
  // è‡ªåŠ¨äº‘åŒæ­¥
  syncToCloud()
}

// === å¯†ç éªŒè¯é€»è¾‘ ===
// éªŒè¯å¯†ç ï¼ˆé€šè¿‡ APIï¼‰
const verifyPassword = async () => {
  try {
    const response = await fetch('/api/private/verify', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ password: passwordInput.value })
    })

    const result = await response.json()

    if (response.ok && result.success) {
      isPrivateUnlocked.value = true
      showPasswordModal.value = false
      activeCategory.value = 'private'
      passwordError.value = false
      passwordInput.value = ''
    } else {
      passwordError.value = true
    }
  } catch (error) {
    console.error('å¯†ç éªŒè¯å¤±è´¥:', error)
    passwordError.value = true
  }
}

// å–æ¶ˆå¯†ç è¾“å…¥
const cancelPassword = () => {
  showPasswordModal.value = false
  passwordInput.value = ''
  passwordError.value = false
}

// === äº‘åŒæ­¥åŠŸèƒ½ ===
// ä¿å­˜åŒæ­¥ token
watch(syncAuthToken, () => {
  localStorage.setItem('syncAuthToken', syncAuthToken.value)
})

// å¤åˆ¶åŒæ­¥ ID
const copyAuthToken = () => {
  navigator.clipboard.writeText(syncAuthToken.value)
  syncStatus.value = { type: 'success', message: 'ID å·²å¤åˆ¶' }
  setTimeout(() => syncStatus.value = null, 2000)
}

// ç¼–è¾‘ ID ç›¸å…³çŠ¶æ€
const isEditingId = ref(false)
const editingId = ref('')

// å¼€å§‹ç¼–è¾‘ ID
const startEditId = () => {
  editingId.value = syncAuthToken.value
  isEditingId.value = true
}

// ä¿å­˜ ID
const saveId = () => {
  const newId = editingId.value.trim()
  if (!newId) {
    syncStatus.value = { type: 'error', message: 'âŒ ID ä¸èƒ½ä¸ºç©º' }
    setTimeout(() => syncStatus.value = null, 2000)
    return
  }
  syncAuthToken.value = newId
  isEditingId.value = false
  syncStatus.value = { type: 'success', message: 'âœ… ID å·²æ›´æ–°' }
  setTimeout(() => syncStatus.value = null, 2000)
}

// å–æ¶ˆç¼–è¾‘ ID
const cancelEditId = () => {
  editingId.value = ''
  isEditingId.value = false
}

// ä¸Šä¼ åˆ°äº‘ç«¯
const syncToCloud = async () => {
  isSyncing.value = true
  try {
    // ä» localStorage è¯»å–æœ€æ–°çš„åˆ†ç±»é¡ºåºï¼ˆç¡®ä¿æ˜¯æœ€æ–°å€¼ï¼‰
    const latestCategoryOrder = JSON.parse(localStorage.getItem('navCategoryOrder') || '[]')

    const response = await fetch(`${API_BASE}/api/sync/save`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${syncAuthToken.value}`
      },
      body: JSON.stringify({
        favorites: [...favorites.value],
        order: customOrder.value,
        categoryOrder: latestCategoryOrder,  // ä½¿ç”¨ä» localStorage è¯»å–çš„æœ€æ–°å€¼
        visits: visitHistory.value,
        clicks: clickCounts.value,
        timestamp: Date.now()
      })
    })

    const result = await response.json()

    if (response.ok && result.success) {
      syncStatus.value = { type: 'success', message: 'âœ… å·²åŒæ­¥åˆ°äº‘ç«¯' }
      setTimeout(() => {
        syncStatus.value = null
        showSyncModal.value = false
      }, 2000)
    } else {
      syncStatus.value = { type: 'error', message: 'âŒ ' + (result.error || 'åŒæ­¥å¤±è´¥') }
    }
  } catch (error) {
    syncStatus.value = { type: 'error', message: 'âŒ ç½‘ç»œé”™è¯¯: ' + error.message }
  } finally {
    isSyncing.value = false
  }
}

// ä»äº‘ç«¯æ¢å¤
const syncFromCloud = async () => {
  isSyncing.value = true
  try {
    const response = await fetch(`${API_BASE}/api/sync/read?userId=${syncAuthToken.value}`)
    const data = await response.json()

    console.log('ğŸ“¥ ä»äº‘ç«¯è¯»å–çš„æ•°æ®:', data)
    console.log('ğŸ“¥ äº‘ç«¯çš„ categoryOrder:', data.categoryOrder)

    if (response.ok && data.favorites) {
      // æ›´æ–°æœ¬åœ°æ•°æ®
      favorites.value = new Set(data.favorites)
      customOrder.value = data.order || {}
      categoryOrder.value = data.categoryOrder || []
      visitHistory.value = data.visits || {}
      clickCounts.value = data.clicks || {}

      console.log('âœ“ å·²åº”ç”¨ categoryOrder åˆ°å“åº”å¼å˜é‡:', categoryOrder.value)
      console.log('âœ“ categoryOrder ç±»å‹:', typeof categoryOrder.value, 'æ˜¯å¦ä¸ºæ•°ç»„:', Array.isArray(categoryOrder.value))
      console.log('âœ“ categoryOrder é•¿åº¦:', categoryOrder.value.length)

      // ä¿å­˜åˆ° localStorage
      localStorage.setItem('navFavorites', JSON.stringify(data.favorites))
      localStorage.setItem('navCustomOrder', JSON.stringify(data.order))
      localStorage.setItem('navCategoryOrder', JSON.stringify(data.categoryOrder))
      localStorage.setItem('navVisits', JSON.stringify(data.visits))
      localStorage.setItem('navClickCounts', JSON.stringify(data.clicks))

      console.log('âœ“ å·²ä¿å­˜ categoryOrder åˆ° localStorage')

      // éªŒè¯ localStorage æ˜¯å¦æ­£ç¡®ä¿å­˜
      const savedOrder = localStorage.getItem('navCategoryOrder')
      console.log('âœ“ ä» localStorage éªŒè¯è¯»å–:', savedOrder ? JSON.parse(savedOrder) : 'null')

      // å¼ºåˆ¶åˆ·æ–°æ˜¾ç¤º
      draggablesList.value = [...filteredItems.value]

      console.log('âœ“ å½“å‰ sortedNavItems çš„é¡ºåº:', sortedNavItems.value.map(item => item.category))

      syncStatus.value = { type: 'success', message: 'âœ… å·²ä»äº‘ç«¯æ¢å¤' }
      setTimeout(() => {
        syncStatus.value = null
        showSyncModal.value = false
      }, 2000)
    } else {
      syncStatus.value = { type: 'error', message: 'âŒ ' + (data.error || 'æ¢å¤å¤±è´¥') }
    }
  } catch (error) {
    syncStatus.value = { type: 'error', message: 'âŒ ç½‘ç»œé”™è¯¯: ' + error.message }
  } finally {
    isSyncing.value = false
  }
}


// === æ‹–æ‹½æ’åºé€»è¾‘ ===
// æ‹–æ‹½åˆ—è¡¨çš„å“åº”å¼æ•°æ®
const draggablesList = ref([])

// å¤„ç†æ‹–æ‹½ç»“æŸäº‹ä»¶
const onDragEnd = (evt, categoryKey) => {
  const { oldIndex, newIndex } = evt

  // å¦‚æœä½ç½®æ²¡æœ‰å˜åŒ–ï¼Œç›´æ¥è¿”å›
  if (oldIndex === newIndex) return

  // vuedraggable å·²ç»è‡ªåŠ¨æ›´æ–°äº† draggablesListï¼Œæˆ‘ä»¬åªéœ€è¦ä»ä¸­æå–æ–°çš„é¡ºåº
  // è¿™æ¯”ä½¿ç”¨ oldIndex/newIndex æ‰‹åŠ¨æ›´æ–°æ›´å¯é 
  customOrder.value[categoryKey] = draggablesList.value.map(item => item.id || item.url)

  // ä¿å­˜åˆ° localStorage
  localStorage.setItem('navCustomOrder', JSON.stringify(customOrder.value))
}

// æ ¹æ®è‡ªå®šä¹‰æ’åºå¯¹é¡¹ç›®è¿›è¡Œæ’åº
const sortItemsByCustomOrder = (items, categoryKey) => {
  const order = customOrder.value[categoryKey]
  if (!order || order.length === 0) return items

  // åˆ›å»ºé¡¹ç›®æ˜ å°„
  const itemMap = {}
  items.forEach(item => {
    const key = item.id || item.url
    itemMap[key] = item
  })

  // æŒ‰ç…§è‡ªå®šä¹‰é¡ºåºè¿”å›
  const sortedItems = []
  order.forEach(key => {
    if (itemMap[key]) {
      sortedItems.push(itemMap[key])
      delete itemMap[key]
    }
  })

  // æ·»åŠ æ–°æ·»åŠ çš„é¡¹ï¼ˆä¸åœ¨è‡ªå®šä¹‰æ’åºä¸­çš„ï¼‰
  Object.values(itemMap).forEach(item => {
    sortedItems.push(item)
  })

  return sortedItems
}

// === é€»è¾‘å‡½æ•° ===
const switchEngine = (engine) => {
  currentEngine.value = engine
  showEngineList.value = false
}

const handleSearch = () => {
  if (!searchQuery.value) return
  window.open(currentEngine.value.url + encodeURIComponent(searchQuery.value), '_blank')
}

const getIconSrc = (item) => {
  if (item.iconUrl) return item.iconUrl
  try {
    let domain = item.url
    if (!domain.startsWith('http')) domain = 'https://' + domain
    const hostname = new URL(domain).hostname
    return `https://www.google.com/s2/favicons?domain=${hostname}&sz=128`
  } catch (e) {
    return 'https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f310.png'
  }
}

const handleImageError = (e) => {
  e.target.src = 'https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f310.png'
}

// ç­›é€‰é€»è¾‘
const filteredItems = computed(() => {
  let items = []
  let categoryKey = activeCategory.value

  if (activeCategory.value === 'frequent') {
    // å¸¸ç”¨ï¼šæ˜¾ç¤ºæœ€å¸¸è®¿é—®çš„ç½‘ç«™
    navItems.value.forEach(category => items = items.concat(category.items))
    // æŒ‰ç‚¹å‡»æ¬¡æ•°æ’åºï¼Œå–å‰ 16 ä¸ª
    items = items
      .sort((a, b) => (clickCounts.value[b.url] || 0) - (clickCounts.value[a.url] || 0))
      .slice(0, 16)
  } else if (activeCategory.value === 'favorites') {
    // æˆ‘çš„æ”¶è—ï¼šæ˜¾ç¤ºæ‰€æœ‰æ”¶è—çš„é¡¹ç›®
    navItems.value.forEach(category => {
      category.items.forEach(item => {
        if (isFavorite(item)) {
          items.push(item)
        }
      })
    })
    // åº”ç”¨è‡ªå®šä¹‰æ’åº
    items = sortItemsByCustomOrder(items, 'favorites')
  } else if (activeCategory.value === 'private') {
    // ç§å¯†åˆ†ç±»ï¼šéœ€è¦å¯†ç éªŒè¯
    if (!isPrivateUnlocked.value) {
      // å¦‚æœæœªè§£é”ï¼Œä¸æ˜¾ç¤ºä»»ä½•å†…å®¹
      return []
    }
    // æŸ¥æ‰¾ç§å¯†åˆ†ç±»
    const category = navItems.value.find(c => c.category === 'ç§å¯†')
    if (category) {
      items = category.items
      // åº”ç”¨è‡ªå®šä¹‰æ’åº
      items = sortItemsByCustomOrder(items, 'ç§å¯†')
    }
  } else {
    // æ™®é€šåˆ†ç±»
    const category = navItems.value.find(c => c.category === activeCategory.value)
    if (category) {
      items = category.items
      // åº”ç”¨è‡ªå®šä¹‰æ’åº
      items = sortItemsByCustomOrder(items, activeCategory.value)
    }
  }

  if (searchQuery.value.trim()) {
    const query = searchQuery.value.toLowerCase()
    items = items.filter(item =>
      item.name.toLowerCase().includes(query) ||
      (item.desc && item.desc.toLowerCase().includes(query))
    )
  }
  return items
})

// æ˜¯å¦å¯ç”¨æ‹–æ‹½ï¼ˆå¸¸ç”¨åˆ†ç±»ä¸å¯ç”¨æ‹–æ‹½ï¼Œå› ä¸ºå®ƒæ˜¯åŠ¨æ€ç”Ÿæˆçš„ï¼‰
const enableDrag = computed(() => {
  return activeCategory.value !== 'frequent'
})

// ç›‘å¬ activeCategory å˜åŒ–ï¼Œæ›´æ–°æ‹–æ‹½æ•°ç»„
watch(activeCategory, () => {
  draggablesList.value = [...filteredItems.value]
}, { immediate: true })

// ç›‘å¬æœç´¢æŸ¥è¯¢å˜åŒ–ï¼Œæ›´æ–°æ‹–æ‹½æ•°ç»„
watch(searchQuery, () => {
  draggablesList.value = [...filteredItems.value]
})
</script>

<style>
/* CSS å˜é‡ */
:root {
  /* ä¸»è‰²è°ƒ */
  --primary-from: rgb(147, 51, 234);
  --primary-to: rgb(59, 130, 246);

  /* èƒŒæ™¯ç›¸å…³ */
  --bg-image: url('/bg.jpg');
  --bg-saturation: 100%;
  --bg-overlay: rgba(0, 0, 0, 0.1);

  /* ç»ç’ƒæ•ˆæœ */
  --glass-blur: 12px;
  --glass-bg-opacity: 0.7;
  --glass-border: rgba(255, 255, 255, 0.1);

  /* æ–‡å­—é¢œè‰² */
  --text-primary: #f3f4f6;
  --text-secondary: #9ca3af;
}

/* æµ…è‰²æ¨¡å¼è¦†ç›– */
.light {
  --text-primary: #1f2937;
  --text-secondary: #4b5563;
  --glass-bg-opacity: 0.85;
  --bg-overlay: rgba(0, 0, 0, 0.05);
}

/* æ‹–æ‹½æ ·å¼ */
.ghost-card {
  opacity: 0.4;
  background: rgba(168, 85, 247, 0.1);
  border: 2px dashed rgba(168, 85, 247, 0.5);
}

.dragging-card {
  transform: scale(1.05) rotate(2deg);
  box-shadow: 0 20px 40px rgba(168, 85, 247, 0.4);
  z-index: 100;
}

.chosen-card {
  cursor: grabbing !important;
}
</style>