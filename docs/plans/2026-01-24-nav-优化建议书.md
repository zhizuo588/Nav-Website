# Nav-Website 开发建议书

日期：2026-01-24  
范围：前端（Vue/Vite）、Pages Functions、D1、KV、扩展相关接口

本建议书围绕安全、数据一致性、性能成本与可维护性四大方向，提供任务清单与验收标准，便于直接排期执行。

---

## 1) 安全与鉴权（P0）

**目标**：杜绝可预测 token、提升密码安全、统一写接口权限。

**任务清单**
- 密码哈希升级  
  - 选型：PBKDF2 / bcrypt / Argon2（任选其一，推荐 Argon2 或 bcrypt）
  - 注册写入新哈希、登录校验新哈希
  - 旧密码迁移策略：强制重置或“首次登录自动升级哈希”
- Token 策略升级  
  - 生成随机不可预测 token
  - 存储方案：用户表新增 `token_hash` + `expires_at` 或新增 `sessions` 表
  - 支持登出/撤销：退出后 token 失效
- 同步读取接口限制  
  - 移除 `sync/read` 的 `?userId=` 读取方式
  - 仅允许 `Authorization: Bearer <token>` 访问
- 写接口统一鉴权  
  - `websites/add`、`websites/batch-import` 等写接口统一要求鉴权
  - README 与实现保持一致

**验收标准**
- token 无法通过枚举或推断获得
- `sync/read` 不再接受 `userId` query 参数
- 所有写接口未授权返回 401
- 文档与实际鉴权一致

---

## 2) 数据一致性与模型设计（P1）

**目标**：支持空分类、分类稳定存在、URL 唯一性明确。

**任务清单**
- 新增 `categories` 表  
  - 字段：`id`、`name`(唯一)、`created_at`、`updated_at`
  - 数据迁移：从 `websites.category` 提取并初始化分类
- 分类 API 改造  
  - `create/rename/delete` 直接操作 `categories`
  - 删除分类时明确策略：删除网站或移动到默认分类
- 读取数据结构调整  
  - 返回分类时包含空分类
  - 前端可渲染空分类
- URL 唯一性策略  
  - 数据库层添加 `websites.url` UNIQUE 约束
  - 或 API 层统一拦截重复 URL 并返回 409

**验收标准**
- 新建分类即刻可见（无网站也可显示）
- 删除/重命名分类后数据一致且无残留
- 同一 URL 无法重复写入

---

## 3) 性能与成本优化（P2）

**目标**：减少 KV 写入频率、提升搜索与导入效率。

**任务清单**
- 云同步节流  
  - 收藏/拖拽/编辑触发同步时加入 debounce 或合并队列
  - 设置最小同步间隔（如 1–3 秒）
- 批量导入优化  
  - 使用事务 + 批处理插入
  - 复用 prepared statement
- 搜索与渲染性能  
  - 搜索输入 debounce
  - 大数据量时引入虚拟列表（可选）

**验收标准**
- 连续操作不会频繁触发 KV 写入
- 批量导入 100+ 条记录性能明显改善
- 搜索输入无明显掉帧或卡顿

---

## 4) 可维护性与结构优化（P3）

**目标**：降低 `App.vue` 复杂度，模块清晰可扩展。

**任务清单**
- 组件与逻辑拆分  
  - 建议拆分：`SyncModal.vue`、`AuthModal.vue`、`AdminAuthModal.vue`、`EditWebsiteModal.vue`、`FriendLinksModal.vue`
  - 逻辑拆到 composables：`useAuth`、`useSync`、`useCategories`、`useDragSort`
- API 请求封装  
  - 建立 `apiClient` 统一处理 baseURL、鉴权注入、错误提示
  - 业务逻辑中避免直接 `fetch`
- 状态管理（可选）  
  - 若功能继续膨胀，引入 Pinia 统一管理

**验收标准**
- `App.vue` 主要负责布局与组合，核心逻辑被拆分
- API 请求统一走 `apiClient`
- 新功能只需改动对应模块，不需大改 `App.vue`

